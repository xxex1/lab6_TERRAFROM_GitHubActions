# CI/CD pipeline for Flask Pawnshop Application
# This workflow installs dependencies, runs linting, and executes unit tests

name: Flask Pawnshop App CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 flask unittest-xml-reporting
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run unit tests
      run: |
        python -m unittest discover -s . -p "testprogram.py" -v

    - name: Generate test reports
      run: |
        python testprogram.py
      continue-on-error: true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: test-reports/
        retention-days: 30

  terraform:
    name: Terraform Validation and Plan
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -check -recursive
      working-directory: ./terraform
      continue-on-error: true

    - name: Terraform Init
      id: init
      run: terraform init
      working-directory: ./terraform

    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color
      working-directory: ./terraform

    - name: Terraform Plan
      id: plan
      run: terraform plan -no-color -input=false -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}"
      working-directory: ./terraform
      continue-on-error: true
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_SHCHERBAN_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_SHCHERBAN_KEY }}

    - name: Comment PR with Terraform Plan
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      env:
        PLAN: "${{ steps.plan.outputs.stdout }}"
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
          #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
          #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
          #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

          <details><summary>Show Plan</summary>

          \`\`\`terraform
          ${process.env.PLAN}
          \`\`\`

          </details>

          *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: terraform
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Terraform Init
      run: terraform init
      working-directory: ./terraform

    - name: Terraform Apply
      run: terraform apply -auto-approve -no-color -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}"
      working-directory: ./terraform
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_SHCHERBAN_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_SHCHERBAN_KEY }}

    - name: Get EC2 Instance IP
      id: get-ip
      run: |
        INSTANCE_IP=$(terraform output -raw instance_public_ip)
        echo "instance_ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
      working-directory: ./terraform
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_SHCHERBAN_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_SHCHERBAN_KEY }}

    - name: Wait for EC2 to be ready
      run: |
        echo "Waiting for EC2 instance to be ready..."
        sleep 60

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ steps.get-ip.outputs.instance_ip }} >> ~/.ssh/known_hosts

    - name: Deploy Application Code
      run: |
        # Create deployment package
        tar -czf app.tar.gz app.py templates/

        # Copy to server
        scp -i ~/.ssh/deploy_key app.tar.gz ec2-user@${{ steps.get-ip.outputs.instance_ip }}:/tmp/

        # Extract and restart service
        ssh -i ~/.ssh/deploy_key ec2-user@${{ steps.get-ip.outputs.instance_ip }} << 'ENDSSH'
          cd /opt/webapp
          tar -xzf /tmp/app.tar.gz
          sudo systemctl daemon-reload
          sudo systemctl enable webapp.service
          sudo systemctl restart webapp.service
          sudo systemctl status webapp.service
        ENDSSH

    - name: Display Deployment Info
      run: |
        echo "### Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**EC2 Instance IP:** ${{ steps.get-ip.outputs.instance_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "**Application URL:** http://${{ steps.get-ip.outputs.instance_ip }}:5000" >> $GITHUB_STEP_SUMMARY
        echo "**Region:** eu-central-1" >> $GITHUB_STEP_SUMMARY
        echo "**Instance Type:** t3.micro" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your Flask Pawnshop application is now running!" >> $GITHUB_STEP_SUMMARY
